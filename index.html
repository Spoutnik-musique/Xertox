<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MINIM</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    html, body {
  height: 100vh;
  margin: 0;
  overflow-y: auto; /* autorise scroll SI besoin */
  overflow-x: hidden;
}

  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    background: linear-gradient(135deg, #161c27, #0f172a);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #93c5fd;
    height: 100vh;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-template-rows: 60px 180px 300px 1fr;
    gap: 15px;
    padding: 15px;
    overflow: hidden;
  scrollbar-width: thin;
  scrollbar-color: hsl(0, 0%, 17%) #465e80; /* Firefox */
}

body::-webkit-scrollbar {
  width: 8px;
}

body::-webkit-scrollbar-track {
  background: #3f5779;
  border-radius: 10px;
}

body::-webkit-scrollbar-thumb {
  background-color: #38376b;
  border-radius: 10px;
}

  /* Bento style commun */
  .bento {
  background: linear-gradient(135deg, #1e293b, #0f172a);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    padding: 15px 20px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  .bento-header {
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 10px;
    text-align: center;
  }

  /* Ajustement anciens bentos */
  #clock-analog-container {
    grid-column: 1 / 2;
    grid-row: 1 / 3;
    justify-content: center;
    align-items: center;
    display: flex;
  }

#clock-analog {
  background: #1a1a1a;      /* Fond sombre mais simple */
  border-radius: 50%;       /* Toujours ronde */
  box-shadow: none;         /* Suppression de l’ombre intérieure */
  border: 2px solid #555;   /* Bord discret gris moyen */
  display: block;
  margin: auto;
}

  #digitalClockBento {
    grid-column: 2 / 3;
    grid-row: 1 / 3;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #digitalTime {
    font-size: 3rem;
    font-weight: bold;
    user-select: none;
  }

  #notes-container {
    grid-column: 1 / 3;
    grid-row: 4 / 5;
  }

  #notes {
    flex-grow: 1;
    width: 100%;
    height: 100%;
    background: #1f2937;
    border: none;
    border-radius: 12px;
    padding: 10px;
    font-size: 1rem;
    color: white;
    resize: none;
  }

  #calendar {
    grid-column: 3 / 5;
    grid-row: 1 / 3;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  #calendarContent {
    max-height: 270px;
    overflow-y: auto;
  }

  #calendar table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  #calendar th, #calendar td {
    border: 1px solid #374151;
    text-align: center;
    padding: 6px 0;
    font-size: 0.9rem;
  }

  #calendar th {
    background: #1f2937;
  }

  #calendar td.today {
    background-color: #445063;
    color: white;
    font-weight: bold;
    border-radius: 0%;
  }

#shortcuts {
  grid-column: 3 / 5;
  grid-row: 3 / 4;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  gap: 15px;
  overflow-y: auto;
  border-radius: 16px;
  background: linear-gradient(135deg, #1e293b, #0f172a);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
}

#shortcuts .bento-header {
  font-size: 1.3rem;
  font-weight: 600;
  color: #93c5fd;
  margin-bottom: 10px;
  width: 100%;
  text-align: center;
}

#addShortcutBtn {
  padding: 8px 16px;
  font-size: 0.95rem;
  font-weight: 500;
      background: #3b82f6;

  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

#addShortcutBtn:hover {
  background: #2563eb;
  transform: translateY(-1px);
}

#shortcutLinks {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  width: 100%;
  max-height: 150px;
  overflow-y: auto;
  padding-right: 6px;
}

#shortcutLinks a {
  display: inline-block;
  padding: 6px 14px;
  font-size: 0.95rem;
  font-weight: 500;
  color: #93c5fd;
  background-color: #1e40af;
  border-radius: 999px;
  text-decoration: none;
  transition: all 0.2s ease-in-out;
  user-select: none;
  white-space: nowrap;
}

#shortcutLinks a:hover {
  background-color: #2563eb;
  color: #fff;
  transform: translateY(-1px);
}


  /* Nouveaux widgets */

/* Calculatrice */
#calculator {
  grid-column: 6 / 7;
  grid-row: 1 / 3;
}

#calc-display {
  background: #1f2937;
  border-radius: 8px;        /* Réduction du rayon */
  padding: 6px;              /* Moins de padding */
  font-size: 1rem;           /* Réduit de 1.5rem à 1rem */
  color: white;
  text-align: right;
  margin-bottom: 8px;        /* Moins d'espace en dessous */
  user-select: none;
}

#calc-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;                  /* Encore moins d'espace entre les boutons */
}

#calc-buttons button {
  background: #374151;
  border: none;
  border-radius: 8px;        /* Plus petit rayon */
  color: white;
  font-size: 0.80rem;        /* Plus petit texte */
  padding: 5px 0;            /* Réduction verticale */
  cursor: pointer;
  user-select: none;
  transition: background-color 0.2s;
}

#calc-buttons button:hover {
  background: #6e6e6e;
}

  /* Suivi sommeil */
  #sleepTracker {
    grid-column: 5 / 6;
    grid-row: 3 / 4;
  }
  #sleepHours {
    width: 100%;
    font-size: 1.2rem;
    padding: 10px;
    border-radius: 12px;
    border: none;
    background: #1f2937;
    color: white;
    margin-bottom: 10px;
  }
  #sleepSubmit {
    background: #3b82f6;
    border: none;
    border-radius: 12px;
    padding: 10px;
    font-size: 1rem;
    color: white;
    cursor: pointer;
  }
  #sleepSubmit:hover {
    background: #2563eb;
  }
  #sleepLog {
    margin-top: 10px;
    max-height: 120px;
    overflow-y: auto;
    font-size: 0.9rem;
    background: #1f2937;
    border-radius: 12px;
    padding: 10px;
  }
#currentDate {
  grid-column: 5 / 6;
  grid-row: 1 / 3;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

  /* ToDo List */
  #todo {
    grid-column: 3 / 5;
    grid-row: 4 / 5;
    display: flex;
    flex-direction: column;
  }
  #todoInput {
    padding: 10px;
    border-radius: 12px;
    border: none;
    background: #1f2937;
    color: white;
    font-size: 1rem;
    margin-bottom: 10px;
  }
  #todoAddBtn {
    background: #3b82f6;
    border: none;
    border-radius: 12px;
    padding: 10px;
    font-size: 1rem;
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
  }
  #todoAddBtn:hover {
    background: #2563eb;
  }
  #todoList {
    flex-grow: 1;
    overflow-y: auto;
    background: #1f2937;
    border-radius: 12px;
    padding: 10px;
  }
  #todoList li {
    list-style: none;
    padding: 8px 5px;
    border-bottom: 1px solid #374151;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: default;
  }
  #todoList li.completed {
    text-decoration: line-through;
    color: #6b7280;
  }
  #todoList li button {
    background: none;
    border: none;
    color: #ef4444;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
  }

  /* Météo locale */
  #weather {
    grid-column: 6 /7;
    grid-row: 3 / 4;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #weatherIcon {
    width: 100px;
    height: 100px;
    margin-bottom: 10px;
  }
  #weatherTemp {
    font-size: 2rem;
    font-weight: bold;
  }
  #weatherDesc {
    font-size: 1.2rem;
    margin-bottom: 5px;
  }
  #weatherLocation {
    font-size: 1rem;
    color: #9ca3af;
  }
#timerWidget .mode-btn {
  background-color: #374151; /* gris foncé */
  color: white;
  border: none;
  padding: 8px 16px;
  margin: 5px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: background 0.3s ease, transform 0.1s ease;
}

#timerWidget .mode-btn:hover {
  background-color: #4b5563; /* plus clair au hover */
  transform: scale(1.03);
}

#timerWidget .mode-btn.active {
  background-color: #2563eb; /* bleu vif pour actif */
}

#timerWidget button {
  background-color: #2563eb; /* vert pour les boutons start/pause/reset */
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 1.2rem;
  margin: 5px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.3s ease, transform 0.1s ease;
}

#timerWidget button:hover {
  background-color: #143888;
  transform: scale(1.05);
}

#timerWidget button:active {
  transform: scale(0.97);
}

#timerWidget #startTimer {
  background-color: #2563eb; /* vert */
}

#timerWidget #stopTimer {
  background-color: #2563eb; /* orange */
}

#timerWidget #resetTimer {
  background-color: #2563eb; /* rouge */
}

#timerWidget #startTimer:hover {
  background-color: #143888;
}

#timerWidget #stopTimer:hover {
  background-color: #143888;
}

#timerWidget #resetTimer:hover {
  background-color: #143888;
}
#timerInputs input {
  padding: 10px;
  border-radius: 12px;
  border: none;
  background: #1f2937;
  color: white;
  font-size: 1rem;
  width: 80px;
  margin-right: 5px;
  text-align: center;
  box-sizing: border-box;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

#timerInputs input:last-child {
  margin-right: 0;
}

#timerInputs input:focus {
  outline: none;
  background: #2563eb; /* bleu vif au focus */
  box-shadow: 0 0 8px #2563eb;
  color: white;
}


</style>
</head>
<body>

  <!-- Horloges -->
  <div class="bento" id="clock-analog-container">
    <canvas id="clock-analog" width="150" height="150"></canvas>
  </div>

  <div class="bento" id="digitalClockBento">
    <div class="bento-header">Horloge numérique</div>
    <div id="digitalTime"></div>
  </div>

  <!-- Notes -->
  <div class="bento" id="notes-container">
    <div class="bento-header">Prise de notes</div>
    <textarea id="notes" placeholder="Écris ici..."></textarea>
  </div>

  <!-- Calendrier -->
  <div class="bento" id="calendar">
    <div class="bento-header">Calendrier mensuel</div>
    <div id="calendarContent"></div>
  </div>
<div class="bento" id="sleepAnalysis" style="grid-column: 1 / 3; grid-row: 3 / 4;">

  <div class="bento-header">Analyse du sommeil - Dernière semaine</div>

  <div id="sleepDates" style="display:flex; justify-content: space-between; font-size: 0.85rem; color: #93c5fd; padding: 0 5px 8px 5px; user-select: none;"></div>

  <canvas id="sleepAnalysisChart" style="max-width: 100%; height: 180px;"></canvas>

</div>


<!-- Raccourcis -->
<div class="bento" id="shortcuts">
  <div class="bento-header">Raccourcis</div>
  <button id="addShortcutBtn">➕ Ajouter un raccourci</button>
  <div id="shortcutLinks"></div>
</div>
<!-- Date du jour -->
<div class="bento" id="currentDate">
  <div class="bento-header">Nous sommes le</div>
  <div id="dateDisplay" style="font-size: 1.6rem; text-align: center;"></div>
</div>

  <!-- Calculatrice -->
  <div class="bento" id="calculator">
    <div class="bento-header">Calculatrice</div>
    <div id="calc-display">0</div>
    <div id="calc-buttons">
      <button data-value="7">7</button>
      <button data-value="8">8</button>
      <button data-value="9">9</button>
      <button data-value="/">÷</button>
      <button data-value="4">4</button>
      <button data-value="5">5</button>
      <button data-value="6">6</button>
      <button data-value="*">×</button>
      <button data-value="1">1</button>
      <button data-value="2">2</button>
      <button data-value="3">3</button>
      <button data-value="-">−</button>
      <button data-value="0">0</button>
      <button data-value=".">.</button>
      <button id="calc-clear">C</button>
      <button data-value="+">+</button>
      <button id="calc-equal" style="grid-column: span 4; background: #2563eb;">=</button>
    </div>
  </div>

  <!-- Suivi du sommeil -->
  <div class="bento" id="sleepTracker">
    <div class="bento-header">Suivi du sommeil (heures)</div>
    <input type="number" id="sleepHours" placeholder="Heures dormies" min="0" max="24" step="0.1" />
    <button id="sleepSubmit">Ajouter</button>
    <div id="sleepLog"></div>
  </div>

  <!-- To Do List -->
  <div class="bento" id="todo">
    <div class="bento-header">To Do List</div>
    <input type="text" id="todoInput" placeholder="Nouvelle tâche..." />
    <button id="todoAddBtn">Ajouter</button>
    <ul id="todoList"></ul>
  </div>
<div class="bento" id="timerWidget" style="grid-column: 5 / 7; grid-row: 4 / 5;">
  <div class="bento-header">
    <i class="bi bi-alarm"></i> Minuteur / Chronomètre
  </div>
  <div style="text-align: center; margin-top: 10px;">
    <button id="modeTimer" class="mode-btn active"><i class="bi bi-alarm"></i> Minuteur</button>
    <button id="modeStopwatch" class="mode-btn"><i class="bi bi-stopwatch"></i> Chronomètre</button>
  </div>
  <div id="timerDisplay" style="font-size: 2rem; text-align: center; margin: 15px 0;">00:00</div>

  <div id="timerInputs" style="text-align: center;">
    <input type="number" id="minutesInput" min="0" placeholder="Minutes" style="width: 80px; margin-right: 5px;">
    <input type="number" id="secondsInput" min="0" max="59" placeholder="Secondes" style="width: 80px;">
  </div>

  <div style="text-align: center; margin-top: 10px;">

<button id="startTimer"><i class="bi bi-play-fill"></i></button>
<button id="stopTimer"><i class="bi bi-pause-fill"></i></button>
<button id="resetTimer"><i class="bi bi-stop-fill"></i></button>
  </div>
</div>

  <!-- Météo Locale -->
  <div class="bento" id="weather">
    <div class="bento-header">Météo Locale</div>
    <div id="weatherIcon">
      <!-- Icone météo animée via inline SVG -->
    </div>
    <div id="weatherTemp"></div>
    <div id="weatherDesc"></div>
    <div id="weatherLocation"></div>
  </div>
<!-- 🚩 À placer juste avant </body> -->
<div id="shortcutModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#1e293b; padding:20px 25px; border-radius:12px; width:300px; display:flex; flex-direction:column; gap:10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);">
    <h3 style="margin:0; font-size:1.2rem; color:#93c5fd; text-align:center;">Ajouter un raccourci</h3>
    <input id="shortcutName" type="text" placeholder="Nom" style="padding:8px; border-radius:8px; border:none; background:#334155; color:white;">
    <input id="shortcutURL" type="url" placeholder="https://..." style="padding:8px; border-radius:8px; border:none; background:#334155; color:white;">
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
      <button id="shortcutCancel" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Annuler</button>
      <button id="shortcutSave" style="background:#3b82f6; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Ajouter</button>
    </div>
  </div>
</div>


<script>
  // --- Horloge numérique ---
  function updateDigitalClock() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('fr-FR', {hour12: false});
    document.getElementById('digitalTime').textContent = timeStr;
  }
  setInterval(updateDigitalClock, 1000);
  updateDigitalClock();

  // --- Horloge analogique ---
  function drawAnalogClock() {
    const canvas = document.getElementById('clock-analog');
    const ctx = canvas.getContext('2d');
    const radius = canvas.height / 2;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.translate(radius, radius);

function drawFace() {
  ctx.beginPath();
  ctx.arc(0, 0, radius - 5, 0, 2 * Math.PI);
  ctx.fillStyle = '#1a1a1a';  // Fond sombre
  ctx.fill();

  ctx.strokeStyle = '#555';   // Bord gris discret
  ctx.lineWidth = 2;
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(0, 0, 5, 0, 2 * Math.PI);  // Petit centre plus discret
  ctx.fillStyle = '#555';
  ctx.fill();
}

function drawNumbers() {
  ctx.font = (radius * 0.13) + "px Arial";
  ctx.fillStyle = '#bbb';    // Chiffres gris clair
  ctx.textBaseline = "middle";
  ctx.textAlign = "center";
  for(let num=1; num<=12; num++) {
    let ang = num * Math.PI / 6;
    ctx.rotate(ang);
    ctx.translate(0, -radius * 0.75);
    ctx.rotate(-ang);
    ctx.fillText(num.toString(), 0, 0);
    ctx.rotate(ang);
    ctx.translate(0, radius * 0.75);
    ctx.rotate(-ang);
  }
}

function drawHand(pos, length, width, color='#888') {  // Main gris neutre par défaut
  ctx.beginPath();
  ctx.lineWidth = width;
  ctx.lineCap = "round";
  ctx.strokeStyle = color;
  ctx.moveTo(0, 0);
  ctx.rotate(pos);
  ctx.lineTo(0, -length);
  ctx.stroke();
  ctx.rotate(-pos);
}

function drawTime() {
  const now = new Date();
  let hour = now.getHours() % 12;
  let minute = now.getMinutes();
  let second = now.getSeconds();

  hour = (hour * Math.PI / 6) + (minute * Math.PI / (6 * 60)) + (second * Math.PI / (360 * 60));
  drawHand(hour, radius * 0.5, 6, '#888');

  minute = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60));
  drawHand(minute, radius * 0.7, 4, '#aaa');

  second = (second * Math.PI / 30);
  drawHand(second, radius * 0.85, 1, '#bbb');
}

    ctx.clearRect(-radius, -radius, canvas.width, canvas.height);
    drawFace();
    drawNumbers();
    drawTime();
  }
  setInterval(drawAnalogClock, 1000);
  drawAnalogClock();

  // --- Calendrier mensuel ---
  function generateCalendar(year, month) {
    const calendarContent = document.getElementById('calendarContent');
    const daysOfWeek = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const today = new Date();

    let html = '<table><thead><tr>';
    daysOfWeek.forEach(day => {
      html += '<th>' + day + '</th>';
    });
    html += '</tr></thead><tbody><tr>';

    // Décalage jours avant début mois (lundi = 1)
    let startDay = firstDay.getDay();
    startDay = startDay === 0 ? 7 : startDay; // dimanche à 7
    for(let i=1; i < startDay; i++) {
      html += '<td></td>';
    }

    for(let day=1; day<=lastDay.getDate(); day++) {
      const isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
      if((startDay + day - 2) % 7 === 0 && day !== 1) {
        html += '</tr><tr>';
      }
      html += `<td class="${isToday ? 'today' : ''}">${day}</td>`;
    }

    html += '</tr></tbody></table>';
    calendarContent.innerHTML = html;
  }

  const now = new Date();
  generateCalendar(now.getFullYear(), now.getMonth());

  // --- Notes ---
  const notes = document.getElementById('notes');
  // Optionnel : charger notes depuis localStorage
  if(localStorage.getItem('bentoNotes')) {
    notes.value = localStorage.getItem('bentoNotes');
  }
  notes.addEventListener('input', () => {
    localStorage.setItem('bentoNotes', notes.value);
  });

  // --- Calculatrice ---
  const calcDisplay = document.getElementById('calc-display');
  let calcExpression = '';

  function updateCalcDisplay() {
    calcDisplay.textContent = calcExpression || '0';
  }

  function safeEval(expr) {
    // Sécurité basique : n'accepter que chiffres, opérateurs et points
    if(!/^[0-9+\-*/.() ]*$/.test(expr)) {
      return 'Erreur';
    }
    try {
      let result = Function(`"use strict";return (${expr})`)();
      if(result === undefined) return '';
      if(Number.isFinite(result)) return result.toString();
      else return 'Erreur';
    } catch {
      return 'Erreur';
    }
  }
const shortcutsKey = 'customShortcuts';
const shortcutLinksContainer = document.getElementById('shortcutLinks');
const addBtn = document.getElementById('addShortcutBtn');

// Modale
const modal = document.getElementById('shortcutModal');
const inputName = document.getElementById('shortcutName');
const inputURL = document.getElementById('shortcutURL');
const btnSave = document.getElementById('shortcutSave');
const btnCancel = document.getElementById('shortcutCancel');

// Récupérer favicon via Google favicon API
function getFaviconUrl(url) {
  try {
    const hostname = new URL(url).hostname;
    return `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`;
  } catch {
    return '';
  }
}

// Créer un lien raccourci avec icône + nom
function createShortcutElement(name, url) {
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  a.style.display = 'flex';
  a.style.alignItems = 'center';
  a.style.gap = '6px';
  a.style.padding = '6px 10px';
  a.style.background = '#1f2937';
  a.style.color = '#eee';
  a.style.borderRadius = '8px';
  a.style.textDecoration = 'none';
  a.style.fontWeight = '500';
  a.style.minWidth = '250px';

  const img = document.createElement('img');
  img.src = getFaviconUrl(url);
  img.alt = 'favicon';
  img.style.width = '20px';
  img.style.height = '20px';
  img.style.borderRadius = '4px';
  img.style.objectFit = 'contain';

  const span = document.createElement('span');
  span.textContent = name;

  a.appendChild(img);
  a.appendChild(span);

  return a;
}

// Charger les raccourcis du localStorage et afficher
function loadShortcuts() {
  shortcutLinksContainer.innerHTML = '';
  const saved = localStorage.getItem(shortcutsKey);
  if (!saved) return;

  const shortcuts = JSON.parse(saved);
  shortcuts.forEach(({ name, url }) => {
    const el = createShortcutElement(name, url);
    shortcutLinksContainer.appendChild(el);
  });
}

// Ajouter un raccourci (en le stockant aussi)
function addShortcut(name, url) {
  const saved = localStorage.getItem(shortcutsKey);
  const shortcuts = saved ? JSON.parse(saved) : [];
  shortcuts.push({ name, url });
  localStorage.setItem(shortcutsKey, JSON.stringify(shortcuts));
  loadShortcuts();
}

// Ouvre la modale
addBtn.addEventListener('click', () => {
  inputName.value = '';
  inputURL.value = '';
  modal.style.display = 'flex';
  inputName.focus();
});

// Ferme la modale
btnCancel.addEventListener('click', () => {
  modal.style.display = 'none';
});

// Enregistre le raccourci
btnSave.addEventListener('click', () => {
  const name = inputName.value.trim();
  const url = inputURL.value.trim();

  if (!name || !url) {
    alert("Nom ou URL invalide.");
    return;
  }

  try {
    new URL(url);
  } catch {
    alert("URL invalide.");
    return;
  }

  addShortcut(name, url);
  modal.style.display = 'none';
});

// Fermer modale sur clic hors du bloc
window.addEventListener('click', (e) => {
  if (e.target === modal) {
    modal.style.display = 'none';
  }
});

// Fermer modale avec touche Échap
window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    modal.style.display = 'none';
  }
});

// Initialiser
loadShortcuts();

// --- Date actuelle ---
function formatFrenchDate(date) {
  const options = { day: 'numeric', month: 'long', year: 'numeric' };
  return date.toLocaleDateString('fr-FR', options);
}

document.getElementById('dateDisplay').textContent = formatFrenchDate(new Date());

  // Au chargement
  loadShortcuts();
  document.getElementById('calc-buttons').addEventListener('click', (e) => {
    if(e.target.tagName !== 'BUTTON') return;
    const val = e.target.dataset.value;
    if(val) {
      calcExpression += val;
      updateCalcDisplay();
    } else if(e.target.id === 'calc-clear') {
      calcExpression = '';
      updateCalcDisplay();
    } else if(e.target.id === 'calc-equal') {
      const res = safeEval(calcExpression);
      calcExpression = res === 'Erreur' ? '' : res;
      updateCalcDisplay();
    }
  });

  updateCalcDisplay();

  // --- Suivi sommeil ---
  const sleepInput = document.getElementById('sleepHours');
  const sleepSubmit = document.getElementById('sleepSubmit');
  const sleepLog = document.getElementById('sleepLog');

  let sleepData = JSON.parse(localStorage.getItem('sleepData') || '[]');
  function updateSleepLog() {
    sleepLog.innerHTML = sleepData.length === 0 ? 'Aucune donnée.' :
      sleepData.map(item => `<div>${item.date} : ${item.hours} h</div>`).join('');
  }
  updateSleepLog();

  sleepSubmit.addEventListener('click', () => {
    let hours = parseFloat(sleepInput.value);
    if(isNaN(hours) || hours < 0 || hours > 24) {
      alert('Merci d\'entrer un nombre valide entre 0 et 24.');
      return;
    }
    const date = new Date().toLocaleDateString('fr-FR');
    sleepData.push({date, hours});
    localStorage.setItem('sleepData', JSON.stringify(sleepData));
    updateSleepLog();
    sleepInput.value = '';
  });

  // --- To Do List ---
  const todoInput = document.getElementById('todoInput');
  const todoAddBtn = document.getElementById('todoAddBtn');
  const todoList = document.getElementById('todoList');

  let todos = JSON.parse(localStorage.getItem('todos') || '[]');

let mode = 'timer'; // timer ou stopwatch
let timerInterval;
let timerRemaining = 0;
let stopwatchTime = 0;

const display = document.getElementById("timerDisplay");
const minutesInput = document.getElementById("minutesInput");
const secondsInput = document.getElementById("secondsInput");

document.getElementById("modeTimer").addEventListener("click", () => switchMode('timer'));
document.getElementById("modeStopwatch").addEventListener("click", () => switchMode('stopwatch'));
document.getElementById("startTimer").addEventListener("click", start);
document.getElementById("stopTimer").addEventListener("click", stop);
document.getElementById("resetTimer").addEventListener("click", reset);

function switchMode(newMode) {
  mode = newMode;
  document.getElementById("modeTimer").classList.toggle("active", mode === 'timer');
  document.getElementById("modeStopwatch").classList.toggle("active", mode === 'stopwatch');
  document.getElementById("timerInputs").style.display = mode === 'timer' ? 'block' : 'none';
  reset();
}

function start() {
  stop();

  if (mode === 'timer') {
    const mins = parseInt(minutesInput.value, 10) || 0;
    const secs = parseInt(secondsInput.value, 10) || 0;

    timerRemaining = mins * 60 + secs;

    if (timerRemaining <= 0) {
      updateDisplay(0);
      return;
    }

    updateDisplay(timerRemaining);

    timerInterval = setInterval(() => {
      timerRemaining--;
      updateDisplay(timerRemaining);
      if (timerRemaining <= 0) {
        clearInterval(timerInterval);
        playBeep();
      }
    }, 1000);
  } else {
    timerInterval = setInterval(() => {
      stopwatchTime++;
      updateDisplay(stopwatchTime);
    }, 1000);
  }
}

function stop() {
  clearInterval(timerInterval);
}

function reset() {
  stop();
  if (mode === 'timer') {
    const mins = parseInt(minutesInput.value, 10) || 0;
    const secs = parseInt(secondsInput.value, 10) || 0;
    timerRemaining = mins * 60 + secs;
    updateDisplay(timerRemaining);
  } else {
    stopwatchTime = 0;
    updateDisplay(0);
  }
}

function updateDisplay(seconds) {
  const min = Math.floor(seconds / 60).toString().padStart(2, '0');
  const sec = (seconds % 60).toString().padStart(2, '0');
  display.textContent = `${min}:${sec}`;
}

function playBeep() {
  const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  beep.play();
}


  function renderTodos() {
    todoList.innerHTML = '';
    todos.forEach((todo, idx) => {
      const li = document.createElement('li');
      li.textContent = todo.text;
      if(todo.completed) {
        li.classList.add('completed');
      }
      // Toggle complete on click
      li.addEventListener('click', () => {
        todos[idx].completed = !todos[idx].completed;
        localStorage.setItem('todos', JSON.stringify(todos));
        renderTodos();
      });
      // Delete button
      const delBtn = document.createElement('button');
      delBtn.textContent = '×';
      delBtn.title = 'Supprimer';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        todos.splice(idx, 1);
        localStorage.setItem('todos', JSON.stringify(todos));
        renderTodos();
      });
      li.appendChild(delBtn);
      todoList.appendChild(li);
    });
  }

  todoAddBtn.addEventListener('click', () => {
    const text = todoInput.value.trim();
    if(text.length === 0) return;
    todos.push({text, completed: false});
    localStorage.setItem('todos', JSON.stringify(todos));
    renderTodos();
    todoInput.value = '';
  });
  renderTodos();

  // --- Météo locale ---
  const weatherIcon = document.getElementById('weatherIcon');
  const weatherTemp = document.getElementById('weatherTemp');
  const weatherDesc = document.getElementById('weatherDesc');
  const weatherLocation = document.getElementById('weatherLocation');

  function setWeatherIcon(code) {
    // Icônes météo animées simples inline SVG
    // Pour simplifier ici, on met des emojis ou des SVG basiques
    let svg = '';
    if(code === 'clear') {
      svg = `<svg width="100" height="100" viewBox="0 0 64 64" fill="#facc15" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="14"/><g stroke="#fbbf24" stroke-width="4"><line x1="32" y1="4" x2="32" y2="18"/><line x1="32" y1="46" x2="32" y2="60"/><line x1="4" y1="32" x2="18" y2="32"/><line x1="46" y1="32" x2="60" y2="32"/><line x1="12" y1="12" x2="22" y2="22"/><line x1="42" y1="42" x2="52" y2="52"/><line x1="12" y1="52" x2="22" y2="42"/><line x1="42" y1="22" x2="52" y2="12"/></g></svg>`;
    } else if(code === 'cloud') {
      svg = `<svg width="100" height="100" viewBox="0 0 64 64" fill="#9ca3af" xmlns="http://www.w3.org/2000/svg"><ellipse cx="32" cy="40" rx="22" ry="14"/><ellipse cx="24" cy="34" rx="16" ry="12"/></svg>`;
    } else if(code === 'rain') {
      svg = `<svg width="100" height="100" viewBox="0 0 64 64" fill="#3b82f6" xmlns="http://www.w3.org/2000/svg"><ellipse cx="32" cy="38" rx="22" ry="14" fill="#6b7280"/><ellipse cx="24" cy="32" rx="16" ry="12" fill="#9ca3af"/><line x1="20" y1="52" x2="20" y2="62" stroke="#3b82f6" stroke-width="3" /><line x1="30" y1="52" x2="30" y2="62" stroke="#3b82f6" stroke-width="3" /><line x1="40" y1="52" x2="40" y2="62" stroke="#3b82f6" stroke-width="3" /></svg>`;
    } else if(code === 'snow') {
      svg = `<svg width="100" height="100" viewBox="0 0 64 64" fill="#e0f2fe" xmlns="http://www.w3.org/2000/svg"><ellipse cx="32" cy="38" rx="22" ry="14" fill="#9ca3af"/><ellipse cx="24" cy="32" rx="16" ry="12" fill="#cbd5e1"/><text x="10" y="58" font-size="32" fill="#e0f2fe">*</text></svg>`;
    } else {
      svg = `<div style="font-size: 60px;">☁️</div>`;
    }
    weatherIcon.innerHTML = svg;
  }

  function fetchWeather(lat, lon) {
    // Utilisation API météo Open-Meteo (gratuite, pas d'API key)
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&temperature_unit=celsius`;
    fetch(url).then(res => res.json()).then(data => {
      if(data && data.current_weather) {
        const temp = data.current_weather.temperature;
        const weatherCode = data.current_weather.weathercode;
        weatherTemp.textContent = temp.toFixed(1) + ' °C';
        // Classification simplifiée weathercode https://open-meteo.com/en/docs#latitude=52.52&longitude=13.41&hourly=temperature_2m
        // Pour faire simple on mappe weathercode en "clear", "cloud", "rain", "snow"
        let codeCategory = 'cloud';
        if(weatherCode === 0) codeCategory = 'clear';
        else if([1,2,3].includes(weatherCode)) codeCategory = 'cloud';
        else if([51,53,55,61,63,65,80,81,82].includes(weatherCode)) codeCategory = 'rain';
        else if([71,73,75,77,85,86].includes(weatherCode)) codeCategory = 'snow';

        setWeatherIcon(codeCategory);
        weatherDesc.textContent = weatherCode === 0 ? 'Dégagé' :
          codeCategory === 'cloud' ? 'Nuageux' :
          codeCategory === 'rain' ? 'Pluvieux' :
          codeCategory === 'snow' ? 'Neige' : 'Inconnu';

        weatherLocation.textContent = `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)}`;
      } else {
        weatherTemp.textContent = 'N/A';
        weatherDesc.textContent = 'Données météo indisponibles';
      }
    }).catch(() => {
      weatherTemp.textContent = 'Erreur';
      weatherDesc.textContent = 'Impossible de récupérer la météo';
    });
  }

// Forçage de la météo à Combs-la-Ville (Île-de-France)
const latitude = 48.66;
const longitude = 2.56;

fetchWeather(latitude, longitude);

// Actualiser la météo toutes les 60 secondes
setInterval(() => {
  fetchWeather(latitude, longitude);
}, 60000);

// Récupérer le contexte du canvas
const ctx = document.getElementById('sleepAnalysisChart').getContext('2d');

// Fonction pour récupérer les 7 derniers jours
function getLast7Days() {
  const days = [];
  const today = new Date();
  for(let i = 6; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    days.push(d);
  }
  return days;
}

// Formatte en 'dd/mm'
function formatDateLabel(date) {
  return date.getDate().toString().padStart(2,'0') + '/' + (date.getMonth()+1).toString().padStart(2,'0');
}

const sleepDatesDiv = document.getElementById('sleepDates');

function renderDates() {
  const dates = getLast7Days().map(formatDateLabel);
  // On crée une div par date pour espacer
  sleepDatesDiv.innerHTML = dates.map(d => `<div style="flex:1; text-align:center;">${d}</div>`).join('');
}

// Appel initial
renderDates();

// Calcul moyenne des heures par jour sur la semaine
function getWeeklySleepData() {
  const last7 = getLast7Days();
  const data = [];

  last7.forEach(day => {
    const dayStr = day.toLocaleDateString('fr-FR');
    const entries = sleepData.filter(e => e.date === dayStr);
    const avg = entries.length ? entries.reduce((sum,e) => sum + e.hours,0) / entries.length : 0;
    data.push(+avg.toFixed(2));
  });
  return {labels: last7.map(formatDateLabel), data};
}

// Crée le graphique ou met à jour s'il existe déjà
let chart;

function renderChart() {
  const {labels, data} = getWeeklySleepData();

  if(chart) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
    return;
  }

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Heures dormies',
        data,
        backgroundColor: '#3b82f6',
        borderRadius: 6,
      }]
    },
options: {
  scales: {
    x: {
      ticks: {
        display: false // <-- cache les labels sous le graphique
      },
      grid: {
        display: false // optionnel : cacher la grille verticale si tu veux
      }
    },
    y: {
      beginAtZero: true,
      title: {
        display: true,
        text: 'Heures'
      }
    }
  },
  plugins: {
    legend: {
      display: true,
      labels: {
        color: '#93c5fd' // couleur claire pour la légende
      }
    },
    title: {
      display: true,
      text: 'Analyse du sommeil - Dernière semaine',
      color: '#93c5fd',
      font: { size: 16, weight: 'bold' }
    }
  }
}

  });
}
function updateDateNow() {
  const now = new Date();
  const formattedDate = now.toLocaleDateString('fr-FR', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  const dateNowElement = document.getElementById("dateNow");
  if (dateNowElement) {
    dateNowElement.textContent = formattedDate;
  }
}

// Initialisation
renderChart();
let currentDay = new Date().getDate();

setInterval(() => {
  const now = new Date();
  const newDay = now.getDate();

  if (newDay !== currentDay) {
    currentDay = newDay;
    generateCalendar(); // met à jour le calendrier
    updateDateNow();    // met à jour la date du widget
  }
}, 60000); // toutes les minutes

</script>

</body>
</html>
